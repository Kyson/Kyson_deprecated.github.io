---
layout: post
title: TCP/IP概要
published: true
---

前阵子的项目中用到了socket通讯，虽然说代码不多不过理解上去确实有困难，作为程序员感觉还是需要从原理上了解一下TCP/IP的，所以复习了一下（为什么说复习?因为大学有这个课程，不过没认真学）。

## OIS模型

说到TCP/IP，最先想到的肯定是7层OSI模型：

![tcp-ip-osi](https://raw.githubusercontent.com/Kyson/Kyson.github.io/master/images/post_img/TCP-IP%E6%A6%82%E8%A6%81/tcp-ip-osi.png)

这个图不陌生，那么它是什么意思？

## 实例分析

假设我们现在想要通讯，A发一封邮件给B，怎么发？

有几点关键的地方：

- 我们要把内容进行转换，才能被计算机认出来
- 需要知道B的地址在哪儿
- B需要知道用哪个程序来处理接收到的内容

下面具体分析下。

### 应用层

A写一句“hello”，计算机首先把文字进行相应的编码，以便于计算机的识别与传输，这个是应用层做的事情。

> 关于编码可以看我另一篇文章：[字符编码](http://blog.hikyson.cn/%E5%AD%97%E7%AC%A6%E7%BC%96%E7%A0%81/)

### 传输层

然后将编码数据给计算机的TCP模块（传输层的协议），TCP收到之后在数据前面加一些信息，也就是目标端口号和源端口号（可能还有其他的）。

> 端口号的作用就是识别同一台设备中的不同应用模块，一台设备的作用很多，对于通信来说它不会知道传过来的数据用哪个应用处理，这时候就用端口号来识别。比如端口号80，计算机就会用应用层的http模块来处理。

这样B接收到数据之后就知道用什么应用来处理这个数据了。

### 网络层

然后，我们把TCP封装好的整个数据传给IP模块（网络层的协议），IP模块会继续在数据前面加上自己的信息，对于IP协议来讲就是ip地址。

> ipv4使用4个字节32位来表示，用于识别网络上的具体位置。

ok，万事具备，A把数据经过应用层，传输层，网络层的包装之后通过物理的线路发送给了B，B拿到数据之后就开始一层层剥开，识别出端口号，然后根据端口号找到计算机里面的对应应用，然后应用再解析出来数据，展示给用户。

**到此整个传输流程就走完了。**

### 数据链路层

这边有个问题，理论上知道了IP之后数据就可以发送了，但是这边涉及到真正物理世界的一个问题，在以太网协议里规定，必须要知道目标计算机的mac地址才能进行通信，所以仅仅知道IP地址是不够的。

> mac地址，也叫物理地址，用于在网络中唯一标示一个网卡。本文通俗起见，直接把网卡称为了计算机。

这时候问题来了，怎么根据IP地址知道对应计算机的mac地址呢？这就涉及到了一个重要的协议：ARP（地址解析协议）。

ARP的作用顾名思义，就是用来解析ip地址的，A首先在同网段的网络里广播：谁知道ip地址192.168.11.22的mac地址？然后找到中间节点L，L返回它自己的mac地址，然后A的数据先发送给L，然后L也发送一个ARP请求，找到目标B，B返回mac地址给L，然后L把数据发送给B。

> 转发过程叫ARP代理。
> 事实上，每个设备中都会有一个ARP缓存表，用于缓存ip地址和mac地址对应关系，如果缓存中存在对应关系的话是不需要广播的。

整个TCP/IP协议大概就是这样，写完收工。

*【参考文献】*

- [wiki-地址解析协议](https://zh.wikipedia.org/wiki/%E5%9C%B0%E5%9D%80%E8%A7%A3%E6%9E%90%E5%8D%8F%E8%AE%AE)
- 图解TCP/IP